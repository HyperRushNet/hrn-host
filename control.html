<!DOCTYPE html>
<html>
<head>
  <title>Controller</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<h1>Controller (Peer 1)</h1>

<button id="startOffer">Maak Offer + verzamel ICE</button><br><br>

<label>Deelbare string (voor Game of QR):</label><br>
<textarea id="combinedString" style="width:100%; height:120px;" readonly></textarea><br><br>

<div id="qrcode"></div><br>

<label>Answer SDP plakken:</label><br>
<textarea id="answerSDP" style="width:100%; height:120px;"></textarea><br><br>

<label>Answer ICE Candidates plakken (JSON array):</label><br>
<textarea id="answerICE" style="width:100%; height:80px;"></textarea><br><br>

<button id="acceptAnswer">Plak Answer + ICE en verbind</button><br><br>

<button id="sendJump">Jump</button>
<button id="sendAttack">Attack</button>

<p>Logs:<br><pre id="log"></pre></p>

<script>
  let pc = null;
  let dc = null;
  let offerCandidates = [];
  const logElem = document.getElementById('log');

  function log(msg){ logElem.textContent += msg + "\n"; }

  function createPeerConnection() {
    pc = new RTCPeerConnection();
    dc = pc.createDataChannel("data");
    dc.onopen = () => log("DataChannel open!");
    dc.onmessage = e => log("Feedback: " + e.data);
    pc.onicecandidate = e => {
      if(e.candidate) {
        offerCandidates.push(e.candidate.toJSON());
        updateCombinedString();
      }
    };
  }

  function updateCombinedString() {
    const offerSDP = pc.localDescription;
    const combined = {
      sdp: offerSDP,
      ice: offerCandidates
    };
    const jsonStr = JSON.stringify(combined);
    document.getElementById('combinedString').value = jsonStr;
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById("qrcode"), {
      text: jsonStr,
      width: 256,
      height: 256
    });
  }

  document.getElementById('startOffer').onclick = async () => {
    createPeerConnection();
    offerCandidates = [];
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    log("Offer gemaakt");
  };

  document.getElementById('acceptAnswer').onclick = async () => {
    const answer = JSON.parse(document.getElementById('answerSDP').value);
    await pc.setRemoteDescription(answer);
    const candidates = JSON.parse(document.getElementById('answerICE').value);
    for(const c of candidates){
      await pc.addIceCandidate(new RTCIceCandidate(c));
    }
    log("Answer + ICE toegevoegd");
  };

  document.getElementById('sendJump').onclick = () => {
    if(dc && dc.readyState === 'open'){
      dc.send("jump");
      log("Jump gestuurd");
    } else {
      log("DataChannel niet open");
    }
  };

  document.getElementById('sendAttack').onclick = () => {
    if(dc && dc.readyState === 'open'){
      dc.send("attack");
      log("Attack gestuurd");
    } else {
      log("DataChannel niet open");
    }
  };
</script>
</body>
</html>
