<!DOCTYPE html>
<html>
<head><title>Controller</title></head>
<body>
<h1>Controller (Peer 1)</h1>

<button id="startOffer">Maak aanbod (SDP + ICE)</button><br><br>

<label>Plakbare verbindingsstring:</label><br>
<textarea id="connectionString" style="width:100%; height:120px;" readonly></textarea><br><br>

<label>Answer string ontvangen:</label><br>
<textarea id="answerString" style="width:100%; height:120px;"></textarea><br><br>

<button id="connect">Verbind met antwoord</button><br><br>

<button id="sendJump">Jump</button>
<button id="sendAttack">Attack</button>

<p>Logs:<br><pre id="log"></pre></p>

<script>
  let pc = null, dc = null;
  let offerCandidates = [];
  const log = msg => logElem.textContent += msg + "\n";
  const logElem = document.getElementById('log');

  function createPeerConnection() {
    pc = new RTCPeerConnection();
    dc = pc.createDataChannel("data");

    dc.onopen = () => log("DataChannel open!");
    dc.onmessage = e => log("Feedback: " + e.data);

    pc.onicecandidate = e => {
      if (e.candidate) {
        offerCandidates.push(e.candidate.toJSON());
        updateCombinedString();
      }
    };
  }

  function updateCombinedString() {
    const data = {
      sdp: pc.localDescription,
      ice: offerCandidates
    };
    const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
    document.getElementById('connectionString').value = base64;
  }

  document.getElementById('startOffer').onclick = async () => {
    createPeerConnection();
    offerCandidates = [];

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    updateCombinedString();
    log("Offer aangemaakt");
  };

  document.getElementById('connect').onclick = async () => {
    const raw = document.getElementById('answerString').value.trim();
    if (!raw) return;

    const json = JSON.parse(decodeURIComponent(escape(atob(raw))));
    await pc.setRemoteDescription(json.sdp);
    for (const c of json.ice) {
      await pc.addIceCandidate(new RTCIceCandidate(c));
    }
    log("Verbonden met answer");
  };

  document.getElementById('sendJump').onclick = () => {
    if (dc && dc.readyState === "open") {
      dc.send("jump");
      log("Jump gestuurd");
    } else log("Kanaal niet open");
  };

  document.getElementById('sendAttack').onclick = () => {
    if (dc && dc.readyState === "open") {
      dc.send("attack");
      log("Attack gestuurd");
    } else log("Kanaal niet open");
  };
</script>
</body>
</html>
