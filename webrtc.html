<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WebRTC werkende DataChannel met snelle signaling</title>
<style>
  body { font-family: monospace; background:#111; color:#eee; padding:1rem; }
  video { width: 45%; background:#222; margin:0.5rem; border: 2px solid #444; vertical-align: top; }
  textarea { width: 100%; height: 5rem; background:#222; color:#eee; border:1px solid #555; font-family: monospace; resize:none; }
  button { padding: 0.5rem 1rem; margin: 0.5rem 0.2rem; cursor: pointer; background:#333; border:none; color:#eee; }
  #chat { width: 90%; height: 100px; overflow-y: auto; background:#222; border:1px solid #555; margin:0.5rem 0; padding:0.3rem; }
  input[type=text] { width: 80%; background:#222; border:1px solid #555; color:#eee; padding:0.3rem; }
</style>
</head>
<body>

<h2>WebRTC DataChannel & Video met snelle signaling en gegarandeerde open</h2>

<div>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<h3>Stap 1: Genereer Offer (copy deze JSON en stuur naar peer)</h3>
<textarea id="offerOutput" readonly></textarea><br/>
<button id="createOfferBtn">Genereer Offer</button>

<h3>Stap 2: Plak Offer van peer (en genereer Answer)</h3>
<textarea id="offerInput"></textarea><br/>
<button id="acceptOfferBtn">Importeer Offer & Genereer Answer</button>

<h3>Stap 3: Plak Answer van peer</h3>
<textarea id="answerInput"></textarea><br/>
<button id="acceptAnswerBtn">Importeer Answer</button>

<h3>DataChannel Chat</h3>
<div id="chat"></div>
<input id="chatInput" type="text" placeholder="Typ bericht..." autocomplete="off" />
<button id="sendChatBtn">Verstuur</button>

<script>
(async () => {
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const offerOutput = document.getElementById("offerOutput");
  const offerInput = document.getElementById("offerInput");
  const answerInput = document.getElementById("answerInput");
  const chat = document.getElementById("chat");
  const chatInput = document.getElementById("chatInput");
  const sendChatBtn = document.getElementById("sendChatBtn");
  const createOfferBtn = document.getElementById("createOfferBtn");
  const acceptOfferBtn = document.getElementById("acceptOfferBtn");
  const acceptAnswerBtn = document.getElementById("acceptAnswerBtn");

  let pc;
  let dataChannel;

  const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = stream;
  } catch (e) {
    alert("Geen toegang tot camera/microfoon: " + e);
  }

  function logChat(msg, from = "Peer") {
    const div = document.createElement("div");
    div.textContent = `${from}: ${msg}`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function createPeerConnection() {
    pc = new RTCPeerConnection(config);

    if (localVideo.srcObject) {
      localVideo.srcObject.getTracks().forEach(track => pc.addTrack(track, localVideo.srcObject));
    }

    pc.ontrack = e => {
      if (remoteVideo.srcObject !== e.streams[0]) {
        remoteVideo.srcObject = e.streams[0];
      }
    };

    // DataChannel events voor de answerer (peer die offer ontvangt)
    pc.ondatachannel = e => {
      dataChannel = e.channel;
      setupDataChannel();
    };
  }

  function setupDataChannel() {
    dataChannel.onopen = () => logChat("DataChannel open!", "System");
    dataChannel.onmessage = e => logChat(e.data, "Peer");
    dataChannel.onclose = () => logChat("DataChannel gesloten", "System");
  }

  function updateLocalDescriptionOutput(textarea) {
    textarea.value = JSON.stringify(pc.localDescription);
  }

  function waitForIceGatheringComplete() {
    return new Promise(resolve => {
      if (pc.iceGatheringState === "complete") {
        resolve();
      } else {
        function checkState() {
          if (pc.iceGatheringState === "complete") {
            pc.removeEventListener("icegatheringstatechange", checkState);
            resolve();
          }
        }
        pc.addEventListener("icegatheringstatechange", checkState);
      }
    });
  }

  createOfferBtn.onclick = async () => {
    createPeerConnection();

    // Maak DataChannel als caller
    dataChannel = pc.createDataChannel("chat");
    setupDataChannel();

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    updateLocalDescriptionOutput(offerOutput);

    await waitForIceGatheringComplete();
    updateLocalDescriptionOutput(offerOutput);
  };

  acceptOfferBtn.onclick = async () => {
    const offerText = offerInput.value;
    if (!offerText) return alert("Plak eerst de offer JSON");
    createPeerConnection();

    try {
      const offerDesc = new RTCSessionDescription(JSON.parse(offerText));
      await pc.setRemoteDescription(offerDesc);
    } catch (e) {
      return alert("Ongeldige offer JSON: " + e);
    }

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    updateLocalDescriptionOutput(answerInput);

    await waitForIceGatheringComplete();
    updateLocalDescriptionOutput(answerInput);
  };

  acceptAnswerBtn.onclick = async () => {
    const answerText = answerInput.value;
    if (!answerText) return alert("Plak eerst de answer JSON");
    try {
      const answerDesc = new RTCSessionDescription(JSON.parse(answerText));
      await pc.setRemoteDescription(answerDesc);
      alert("Answer geÃ¯mporteerd! Verbinding wordt opgezet.");
    } catch (e) {
      alert("Ongeldige answer JSON: " + e);
    }
  };

  sendChatBtn.onclick = () => {
    const msg = chatInput.value.trim();
    if (!msg) return;
    if (!dataChannel || dataChannel.readyState !== "open") {
      alert("DataChannel niet open");
      return;
    }
    dataChannel.send(msg);
    logChat(msg, "Jij");
    chatInput.value = "";
  };

  chatInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendChatBtn.click();
  });

})();
</script>

</body>
</html>
