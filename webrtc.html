<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Peer</title>
  <meta charset="utf-8" />
</head>
<body>
  <h1>WebRTC Peer (binaire string)</h1>

  <button id="makeOffer">Maak Offer + ICE</button><br><br>

  <label>Gecombineerde Offer (binaire string):</label><br>
  <textarea id="offerCombined" style="width:100%; height:120px;"></textarea><br><br>

  <label>Plak binnenkomende Offer (binaire):</label><br>
  <textarea id="remoteOfferCombined" style="width:100%; height:120px;"></textarea><br><br>

  <button id="makeAnswer">Maak Answer + ICE</button><br><br>

  <label>Gecombineerde Answer (binaire string):</label><br>
  <textarea id="answerCombined" style="width:100%; height:120px;"></textarea><br><br>

  <label>Plak binnenkomende Answer (binaire):</label><br>
  <textarea id="remoteAnswerCombined" style="width:100%; height:120px;"></textarea><br><br>

  <button id="acceptAnswer">Plak Answer + ICE</button><br><br>

  <input type="text" id="sendMsg" placeholder="Typ bericht..." />
  <button id="sendBtn">Stuur</button>

  <pre id="log" style="background:#111;color:#0f0;padding:1rem;"></pre>

<script>
let pc, dc;
let localICE = [];

function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

function setupConnection(isInitiator) {
  pc = new RTCPeerConnection();
  pc.onicecandidate = e => {
    if (e.candidate) {
      localICE.push(e.candidate.toJSON());
    }
  };

  if (isInitiator) {
    dc = pc.createDataChannel("chat");
    setupDataChannel();
  } else {
    pc.ondatachannel = e => {
      dc = e.channel;
      setupDataChannel();
    };
  }
}

function setupDataChannel() {
  dc.onopen = () => log("DataChannel open!");
  dc.onmessage = e => log("Peer: " + e.data);
  dc.onclose = () => log("DataChannel gesloten");
}

// Tekst → binaire string
function textToBinary(str) {
  return [...str].map(c => c.charCodeAt(0).toString(2).padStart(16, '0')).join('');
}

// Binaire string → tekst
function binaryToText(bin) {
  let out = '';
  for (let i = 0; i < bin.length; i += 16) {
    const code = parseInt(bin.slice(i, i + 16), 2);
    out += String.fromCharCode(code);
  }
  return out;
}

document.getElementById('makeOffer').onclick = async () => {
  setupConnection(true);
  localICE = [];

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await new Promise(res => setTimeout(res, 1500));

  const data = JSON.stringify({ sdp: pc.localDescription, ice: localICE });
  document.getElementById('offerCombined').value = textToBinary(data);
};

document.getElementById('makeAnswer').onclick = async () => {
  setupConnection(false);
  localICE = [];

  const binary = document.getElementById('remoteOfferCombined').value;
  const json = binaryToText(binary);
  const { sdp, ice } = JSON.parse(json);

  await pc.setRemoteDescription(sdp);
  for (const c of ice) await pc.addIceCandidate(new RTCIceCandidate(c));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  await new Promise(res => setTimeout(res, 1500));

  const data = JSON.stringify({ sdp: pc.localDescription, ice: localICE });
  document.getElementById('answerCombined').value = textToBinary(data);
};

document.getElementById('acceptAnswer').onclick = async () => {
  const binary = document.getElementById('remoteAnswerCombined').value;
  const json = binaryToText(binary);
  const { sdp, ice } = JSON.parse(json);

  await pc.setRemoteDescription(sdp);
  for (const c of ice) await pc.addIceCandidate(new RTCIceCandidate(c));
  log("Verbonden met Answer");
};

document.getElementById('sendBtn').onclick = () => {
  const msg = document.getElementById('sendMsg').value;
  if (dc && dc.readyState === "open") {
    dc.send(msg);
    log("Jij: " + msg);
    document.getElementById('sendMsg').value = "";
  } else {
    log("DataChannel nog niet open");
  }
};
</script>
</body>
</html>
