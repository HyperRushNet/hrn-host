<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Peer</title>
  <meta charset="utf-8" />
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
</head>
<body>
  <h1>WebRTC Peer (2 kanten in 1, gecomprimeerd)</h1>

  <button id="makeOffer">Maak Offer + ICE</button><br><br>

  <label>Gecombineerde Offer (1 string):</label><br>
  <textarea id="offerCombined" style="width:100%; height:120px;"></textarea><br><br>

  <label>Plak binnenkomende Offer:</label><br>
  <textarea id="remoteOfferCombined" style="width:100%; height:120px;"></textarea><br><br>

  <button id="makeAnswer">Maak Answer + ICE</button><br><br>

  <label>Gecombineerde Answer (1 string):</label><br>
  <textarea id="answerCombined" style="width:100%; height:120px;"></textarea><br><br>

  <label>Plak binnenkomende Answer:</label><br>
  <textarea id="remoteAnswerCombined" style="width:100%; height:120px;"></textarea><br><br>

  <button id="acceptAnswer">Plak Answer + ICE</button><br><br>

  <input type="text" id="sendMsg" placeholder="Typ bericht..." />
  <button id="sendBtn">Stuur</button>

  <pre id="log" style="background:#111;color:#0f0;padding:1rem;"></pre>

<script>
let pc, dc;
let localICE = [];

function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

function setupConnection(isInitiator) {
  pc = new RTCPeerConnection();
  pc.onicecandidate = e => {
    if (e.candidate) {
      localICE.push(e.candidate.toJSON());
    }
  };

  if (isInitiator) {
    dc = pc.createDataChannel("chat");
    setupDataChannel();
  } else {
    pc.ondatachannel = e => {
      dc = e.channel;
      setupDataChannel();
    };
  }
}

function setupDataChannel() {
  dc.onopen = () => log("DataChannel open!");
  dc.onmessage = e => log("Peer: " + e.data);
  dc.onclose = () => log("DataChannel gesloten");
}

function compress(obj) {
  return LZString.compressToUTF16(JSON.stringify(obj));
}

function decompress(str) {
  return JSON.parse(LZString.decompressFromUTF16(str));
}

document.getElementById('makeOffer').onclick = async () => {
  setupConnection(true);
  localICE = [];

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // wacht op ICE candidates
  await new Promise(resolve => setTimeout(resolve, 1500));

  const data = {
    sdp: pc.localDescription,
    ice: localICE
  };

  document.getElementById('offerCombined').value = compress(data);
};

document.getElementById('makeAnswer').onclick = async () => {
  setupConnection(false);
  localICE = [];

  const input = document.getElementById('remoteOfferCombined').value;
  const { sdp, ice } = decompress(input);

  await pc.setRemoteDescription(sdp);
  for (const c of ice) await pc.addIceCandidate(new RTCIceCandidate(c));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  await new Promise(resolve => setTimeout(resolve, 1500));

  const data = {
    sdp: pc.localDescription,
    ice: localICE
  };

  document.getElementById('answerCombined').value = compress(data);
};

document.getElementById('acceptAnswer').onclick = async () => {
  const input = document.getElementById('remoteAnswerCombined').value;
  const { sdp, ice } = decompress(input);

  await pc.setRemoteDescription(sdp);
  for (const c of ice) await pc.addIceCandidate(new RTCIceCandidate(c));
  log("Verbonden met Answer");
};

document.getElementById('sendBtn').onclick = () => {
  const msg = document.getElementById('sendMsg').value;
  if (dc && dc.readyState === "open") {
    dc.send(msg);
    log("Jij: " + msg);
    document.getElementById('sendMsg').value = "";
  } else {
    log("DataChannel nog niet open");
  }
};
</script>
</body>
</html>
