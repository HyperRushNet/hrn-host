<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Peer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    textarea { width: 100%; height: 120px; }
    button, input { font-size: 1rem; margin: 0.3rem 0; }
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #0f0; }
    pre { background: #000; padding: 1rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h2>WebRTC Peer (mobiel/desktop, binaire uitwisseling)</h2>

  <button id="makeOffer">Maak Offer + ICE</button><br>
  <label>Offer (binaire string):</label><br>
  <textarea id="offerCombined"></textarea><br>

  <label>Plak binnenkomende Offer:</label><br>
  <textarea id="remoteOfferCombined"></textarea><br>

  <button id="makeAnswer">Maak Answer + ICE</button><br>
  <label>Answer (binaire string):</label><br>
  <textarea id="answerCombined"></textarea><br>

  <label>Plak binnenkomende Answer:</label><br>
  <textarea id="remoteAnswerCombined"></textarea><br>

  <button id="acceptAnswer">Plak Answer + ICE</button><br><br>

  <input type="text" id="sendMsg" placeholder="Typ bericht..." style="width:80%" />
  <button id="sendBtn">Stuur</button>

  <pre id="log"></pre>

<script>
let pc, dc;
let localICE = [];

function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

function setupConnection(isInitiator) {
  pc = new RTCPeerConnection();
  localICE = [];

  pc.onicecandidate = e => {
    if (e.candidate) localICE.push(e.candidate.toJSON());
  };

  if (isInitiator) {
    dc = pc.createDataChannel("chat");
    setupDataChannel();
  } else {
    pc.ondatachannel = e => {
      dc = e.channel;
      setupDataChannel();
    };
  }
}

function setupDataChannel() {
  dc.onopen = () => log("üì∂ Verbonden!");
  dc.onmessage = e => log("üë§ Peer: " + e.data);
  dc.onclose = () => log("‚ùå Verbinding gesloten");
}

function textToBinary(str) {
  return [...str].map(c => c.charCodeAt(0).toString(2).padStart(16, '0')).join('');
}

function binaryToText(bin) {
  let out = '';
  for (let i = 0; i < bin.length; i += 16) {
    out += String.fromCharCode(parseInt(bin.slice(i, i + 16), 2));
  }
  return out;
}

async function waitForICEComplete() {
  return new Promise(resolve => {
    if (pc.iceGatheringState === 'complete') return resolve();
    const check = () => {
      if (pc.iceGatheringState === 'complete') {
        pc.removeEventListener('icegatheringstatechange', check);
        resolve();
      }
    };
    pc.addEventListener('icegatheringstatechange', check);
  });
}

document.getElementById('makeOffer').onclick = async () => {
  setupConnection(true);

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await waitForICEComplete();

  const payload = JSON.stringify({ sdp: pc.localDescription, ice: localICE });
  document.getElementById('offerCombined').value = textToBinary(payload);
};

document.getElementById('makeAnswer').onclick = async () => {
  setupConnection(false);

  const input = document.getElementById('remoteOfferCombined').value;
  const { sdp, ice } = JSON.parse(binaryToText(input));

  await pc.setRemoteDescription(sdp);
  for (const c of ice) await pc.addIceCandidate(new RTCIceCandidate(c));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await waitForICEComplete();

  const payload = JSON.stringify({ sdp: pc.localDescription, ice: localICE });
  document.getElementById('answerCombined').value = textToBinary(payload);
};

document.getElementById('acceptAnswer').onclick = async () => {
  const input = document.getElementById('remoteAnswerCombined').value;
  const { sdp, ice } = JSON.parse(binaryToText(input));

  await pc.setRemoteDescription(sdp);
  for (const c of ice) await pc.addIceCandidate(new RTCIceCandidate(c));
  log("‚úÖ Verbonden met Answer");
};

document.getElementById('sendBtn').onclick = () => {
  const msg = document.getElementById('sendMsg').value;
  if (dc && dc.readyState === "open") {
    dc.send(msg);
    log("üßç Jij: " + msg);
    document.getElementById('sendMsg').value = "";
  } else {
    log("‚ö†Ô∏è Kanaal niet open");
  }
};
</script>
</body>
</html>
