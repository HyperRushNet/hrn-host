<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Peer</title>
  <meta charset="utf-8" />
</head>
<body>
  <h1>WebRTC Peer (2 kanten in 1)</h1>

  <button id="makeOffer">Maak Offer + ICE</button><br><br>

  <label>Offer SDP:</label><br>
  <textarea id="offerSDP" style="width:100%; height:120px;"></textarea><br><br>

  <label>Offer ICE Candidates:</label><br>
  <textarea id="offerICE" style="width:100%; height:80px;"></textarea><br><br>

  <label>Plak binnenkomende Offer SDP:</label><br>
  <textarea id="remoteOfferSDP" style="width:100%; height:120px;"></textarea><br><br>

  <label>Plak binnenkomende Offer ICE Candidates:</label><br>
  <textarea id="remoteOfferICE" style="width:100%; height:80px;"></textarea><br><br>

  <button id="makeAnswer">Maak Answer + ICE</button><br><br>

  <label>Answer SDP:</label><br>
  <textarea id="answerSDP" style="width:100%; height:120px;"></textarea><br><br>

  <label>Answer ICE Candidates:</label><br>
  <textarea id="answerICE" style="width:100%; height:80px;"></textarea><br><br>

  <label>Plak binnenkomende Answer SDP:</label><br>
  <textarea id="remoteAnswerSDP" style="width:100%; height:120px;"></textarea><br><br>

  <label>Plak binnenkomende Answer ICE Candidates:</label><br>
  <textarea id="remoteAnswerICE" style="width:100%; height:80px;"></textarea><br><br>

  <button id="acceptAnswer">Plak Answer + ICE</button><br><br>

  <input type="text" id="sendMsg" placeholder="Typ bericht..." />
  <button id="sendBtn">Stuur</button>

  <pre id="log" style="background:#111;color:#0f0;padding:1rem;"></pre>

<script>
let pc, dc;
let localICE = [], remoteICE = [];

function log(msg) {
  document.getElementById('log').textContent += msg + "\n";
}

function setupConnection(isInitiator) {
  pc = new RTCPeerConnection();
  pc.onicecandidate = e => {
    if (e.candidate) {
      localICE.push(e.candidate.toJSON());
      updateICEFields(isInitiator);
    }
  };

  if (isInitiator) {
    dc = pc.createDataChannel("chat");
    setupDataChannel();
  } else {
    pc.ondatachannel = e => {
      dc = e.channel;
      setupDataChannel();
    };
  }
}

function setupDataChannel() {
  dc.onopen = () => log("DataChannel open!");
  dc.onmessage = e => log("Peer: " + e.data);
  dc.onclose = () => log("DataChannel gesloten");
}

function updateICEFields(isInitiator) {
  const target = isInitiator ? 'offerICE' : 'answerICE';
  document.getElementById(target).value = JSON.stringify(localICE, null, 2);
}

// Make offer
document.getElementById('makeOffer').onclick = async () => {
  setupConnection(true);
  localICE = [];

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  document.getElementById('offerSDP').value = JSON.stringify(pc.localDescription);
};

// Accept offer, make answer
document.getElementById('makeAnswer').onclick = async () => {
  setupConnection(false);
  localICE = [];

  const sdp = document.getElementById('remoteOfferSDP').value;
  const ice = JSON.parse(document.getElementById('remoteOfferICE').value || '[]');
  await pc.setRemoteDescription(JSON.parse(sdp));
  for (const c of ice) await pc.addIceCandidate(new RTCIceCandidate(c));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  document.getElementById('answerSDP').value = JSON.stringify(pc.localDescription);
};

// Accept answer + ICE
document.getElementById('acceptAnswer').onclick = async () => {
  const sdp = document.getElementById('remoteAnswerSDP').value;
  const ice = JSON.parse(document.getElementById('remoteAnswerICE').value || '[]');
  await pc.setRemoteDescription(JSON.parse(sdp));
  for (const c of ice) await pc.addIceCandidate(new RTCIceCandidate(c));
  log("Verbonden met Answer");
};

// Send message
document.getElementById('sendBtn').onclick = () => {
  const msg = document.getElementById('sendMsg').value;
  if (dc && dc.readyState === "open") {
    dc.send(msg);
    log("Jij: " + msg);
    document.getElementById('sendMsg').value = "";
  } else {
    log("DataChannel nog niet open");
  }
};
</script>
</body>
</html>
