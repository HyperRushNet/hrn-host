<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"><title>G</title></head><body>
<h3>Game</h3>
<textarea id="i" style="width:100%;height:100px" placeholder="Plak string"></textarea>
<textarea id="o" style="width:100%;height:100px" placeholder="Terug naar controller"></textarea>
<pre id="l"></pre>
<script>
let logQueue=[], logBusy=false, lastLog="", l=document.getElementById("l");
function log(t){ if(t!==lastLog){ logQueue.push(t); lastLog=t; if(!logBusy) flushLog(); } }
function flushLog(){
  logBusy=true;
  if(window.requestIdleCallback){
    requestIdleCallback(()=>{
      while(logQueue.length)l.textContent+=logQueue.shift()+"\n";
      logBusy=false;
    });
  } else {
    setTimeout(()=>{
      while(logQueue.length)l.textContent+=logQueue.shift()+"\n";
      logBusy=false;
    },0);
  }
}

let i=document.getElementById("i"), o=document.getElementById("o"), p, dc, c=[];
i.oninput=()=>{try{
  let j=JSON.parse(atob(i.value.replace(/\s/g,'')));
  if(p)return;
  p=new RTCPeerConnection({iceServers:[], iceTransportPolicy:"all"});
  p.onicecandidate=e=>{
    if(e.candidate)c.push(e.candidate.toJSON());
    else o.value=btoa(JSON.stringify({s:p.localDescription,c:c}));
  };
  p.ondatachannel=e=>{
    dc=e.channel;
    dc.onopen=()=>log("ðŸŸ¢ Verbonden");
    dc.onclose=()=>log("ðŸ”´ Verbroken");
    dc.onmessage=ev=>{
      let m=ev.data;
      log("â¬…ï¸ "+m);
      let r=(m==="jump")?"gesprongen":(m==="attack")?"aanval":"?";
      if(dc.readyState==="open") dc.send(r), log("âž¡ï¸ "+r);
    };
  };
  p.setRemoteDescription(j.s).then(()=>{
    j.c.forEach(k=>p.addIceCandidate(new RTCIceCandidate(k)));
    return p.createAnswer();
  }).then(a=>p.setLocalDescription(a));
}catch{}};
</script></body></html>
