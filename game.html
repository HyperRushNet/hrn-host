<!DOCTYPE html>
<html>
<head>
  <title>Game</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
<h1>Game (Peer 2)</h1>

<label>Scan QR of plak connectie-string:</label><br>
<textarea id="combinedString" style="width:100%; height:120px;"></textarea><br><br>
<div id="reader" style="width: 300px;"></div><br>
<button id="startCamera">Scan QR</button>
<button id="connect">Verbind</button><br><br>

<label>Answer SDP:</label><br>
<textarea id="answerSDP" style="width:100%; height:120px;" readonly></textarea><br><br>
<label>Answer ICE:</label><br>
<textarea id="answerICE" style="width:100%; height:80px;" readonly></textarea><br><br>

<p>Ontvangen data:<br><pre id="log"></pre></p>

<script>
  let pc = null;
  let dc = null;
  let answerCandidates = [];
  const logElem = document.getElementById('log');

  function log(msg){ logElem.textContent += msg + "\n"; }

  document.getElementById('startCamera').onclick = () => {
    const qr = new Html5Qrcode("reader");
    qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        qr.stop();
        document.getElementById("combinedString").value = decodedText;
        log("QR gescand!");
      },
      (errorMessage) => {}
    );
  };

  document.getElementById('connect').onclick = async () => {
    if(pc) return;
    const data = JSON.parse(document.getElementById('combinedString').value);
    pc = new RTCPeerConnection();
    answerCandidates = [];

    await pc.setRemoteDescription(data.sdp);

    pc.onicecandidate = e => {
      if(e.candidate) {
        answerCandidates.push(e.candidate.toJSON());
        document.getElementById('answerICE').value = JSON.stringify(answerCandidates, null, 2);
      }
    };

    pc.ondatachannel = event => {
      dc = event.channel;
      dc.onopen = () => log("DataChannel open!");
      dc.onmessage = e => {
        log("Ontvangen: " + e.data);
        if (e.data === "jump") {
          dc.send("Speler sprong!");
        } else if (e.data === "attack") {
          dc.send("Speler viel aan!");
        } else {
          dc.send("Onbekend commando");
        }
      };
    };

    for(const c of data.ice){
      await pc.addIceCandidate(new RTCIceCandidate(c));
    }

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    document.getElementById('answerSDP').value = JSON.stringify(pc.localDescription);
    log("Verbonden en answer gegenereerd");
  };
</script>
</body>
</html>
