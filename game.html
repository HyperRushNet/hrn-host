<!DOCTYPE html>
<html>
<head><title>Game</title></head>
<body>
<h1>Game (Peer 2)</h1>

<label>Verbindingsstring van controller plakken:</label><br>
<textarea id="offerString" style="width:100%; height:120px;"></textarea><br><br>

<button id="maakAntwoord">Maak Answer en geef terugstring</button><br><br>

<label>Plakbare antwoordstring (voor controller):</label><br>
<textarea id="answerString" style="width:100%; height:120px;" readonly></textarea><br><br>

<p>Logs:<br><pre id="log"></pre></p>

<script>
  let pc = null, dc = null;
  let answerCandidates = [];
  const log = msg => logElem.textContent += msg + "\n";
  const logElem = document.getElementById('log');

  document.getElementById('maakAntwoord').onclick = async () => {
    const raw = document.getElementById('offerString').value.trim();
    if (!raw) return;

    const parsed = JSON.parse(decodeURIComponent(escape(atob(raw))));
    pc = new RTCPeerConnection();
    answerCandidates = [];

    pc.onicecandidate = e => {
      if (e.candidate) {
        answerCandidates.push(e.candidate.toJSON());
        updateAnswerString();
      }
    };

    pc.ondatachannel = e => {
      dc = e.channel;
      dc.onopen = () => log("DataChannel open!");
      dc.onmessage = ev => {
        log("Ontvangen: " + ev.data);
        if (ev.data === "jump") {
          log("Speler springt");
          dc.send("Gesprongen");
        } else if (ev.data === "attack") {
          log("Speler valt aan");
          dc.send("Aanval uitgevoerd");
        } else {
          dc.send("Onbekend commando");
        }
      };
    };

    await pc.setRemoteDescription(parsed.sdp);
    for (const c of parsed.ice) {
      await pc.addIceCandidate(new RTCIceCandidate(c));
    }

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    updateAnswerString();
    log("Answer aangemaakt");
  };

  function updateAnswerString() {
    const data = {
      sdp: pc.localDescription,
      ice: answerCandidates
    };
    const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
    document.getElementById('answerString').value = base64;
  }
</script>
</body>
</html>
