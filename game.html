<!DOCTYPE html>
<html>
<head>
  <title>Scan Code</title>
  <style>
    video, canvas {
      border: 1px solid black;
      margin-top: 10px;
      width: 320px;
      height: 320px;
    }
    textarea {
      width: 100%;
      height: 80px;
    }
  </style>
</head>
<body>
<h2>Code Scanner (Achtercamera)</h2>
<video id="video" autoplay playsinline></video><br>
<canvas id="scanCanvas" width="320" height="320" style="display:none;"></canvas><br>
<button onclick="scanCode()">Scan</button><br><br>
<textarea id="outputText" placeholder="Gescande output..."></textarea>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('scanCanvas');
const ctx = canvas.getContext('2d');

navigator.mediaDevices.getUserMedia({
  video: {
    facingMode: { exact: "environment" }, // force achtercamera
    width: { ideal: 320 },
    height: { ideal: 320 }
  }
}).then(stream => {
  video.srcObject = stream;
}).catch(() => {
  alert("Kan geen achtercamera openen.");
});

function scanCode() {
  ctx.drawImage(video, 0, 0, 320, 320);
  const imageData = ctx.getImageData(0, 0, 320, 320).data;

  const size = 32;
  const cellSize = 10; // meer ruimte voor detectie
  let bits = "";

  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      let total = 0;
      let count = 0;

      for (let dy = 3; dy < 7; dy++) {
        for (let dx = 3; dx < 7; dx++) {
          let px = x * cellSize + dx;
          let py = y * cellSize + dy;
          let index = (py * 320 + px) * 4;
          let r = imageData[index];
          let g = imageData[index + 1];
          let b = imageData[index + 2];
          let avg = (r + g + b) / 3;
          total += avg;
          count++;
        }
      }

      let avgCell = total / count;
      bits += avgCell < 128 ? "1" : "0";
    }
  }

  let output = "";
  for (let i = 0; i < bits.length; i += 8) {
    const byte = bits.slice(i, i + 8);
    if (byte.length === 8) {
      output += String.fromCharCode(parseInt(byte, 2));
    }
  }

  try {
    const decoded = decodeURIComponent(escape(atob(output)));
    document.getElementById("outputText").value = decoded;
  } catch (e) {
    document.getElementById("outputText").value = "Fout bij decoderen";
  }
}
</script>
</body>
</html>
